{% extends 'archives/base.html' %}

{% block title %}批量添加档案{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-3">批量添加档案</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">首页</a></li>
                <li class="breadcrumb-item active">批量添加档案</li>
            </ol>
        </nav>
    </div>
</div>

{% if messages %}
<div class="row mb-4">
    <div class="col-12">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" role="alert">
            {{ message }}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">选择档案盒</h5>
            </div>
            <div class="card-body">
                <form method="post" id="add-archives-form">
                    {% csrf_token %}
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <label for="archive_box" class="form-label">选择要添加档案的档案盒 <span class="text-danger">*</span></label>
                            <select name="archive_box" id="archive_box" class="form-select" required>
                                <option value="">-- 请选择档案盒 --</option>
                                {% for box in recent_boxes %}
                                <option value="{{ box.id }}">{{ box.name }} - {{ box.get_location_description }}</option>
                                {% empty %}
                                <option value="" disabled>没有可用的档案盒，请先创建</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-info me-1"></i> 
                                显示最近创建的10个非特殊档案盒
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <a href="/create-archive-box/" class="btn btn-outline-primary">
                                <i class="fas fa-plus-circle me-1"></i> 创建新档案盒
                            </a>
                        </div>
                    </div>
                    
                    <h5 class="mb-3">档案信息</h5>
                    <p class="text-muted mb-4">您可以一次添加多份档案。至少填写一行，只有填写了"标题"的行才会被保存。</p>
                    
                    {{ formset.management_form }}
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 5%">#</th>
                                    <th style="width: 25%">标题 <span class="text-danger">*</span></th>
                                    <th style="width: 30%">描述</th>
                                    <th style="width: 15%">入库日期</th>
                                    <th style="width: 10%">份数</th>
                                    <th style="width: 15%">状态</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for form in formset %}
                                <tr class="archive-form-row">
                                    <td class="text-center">{{ forloop.counter }}</td>
                                    <td>
                                        {{ form.title }}
                                        {% if form.title.errors %}
                                        <div class="text-danger">{{ form.title.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ form.description }}
                                        {% if form.description.errors %}
                                        <div class="text-danger">{{ form.description.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ form.import_date }}
                                        {% if form.import_date.errors %}
                                        <div class="text-danger">{{ form.import_date.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ form.copy_count }}
                                        {% if form.copy_count.errors %}
                                        <div class="text-danger">{{ form.copy_count.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="form-check">
                                            {{ form.is_in_stock }}
                                            <label class="form-check-label" for="{{ form.is_in_stock.id_for_label }}">
                                                在库
                                            </label>
                                        </div>
                                        {% if form.is_in_stock.errors %}
                                        <div class="text-danger">{{ form.is_in_stock.errors }}</div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> 保存档案
                        </button>
                        <a href="/" class="btn btn-secondary ms-2">
                            <i class="fas fa-times me-1"></i> 取消
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">批量添加指南</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-lightbulb text-warning me-1"></i> 填写说明：</h6>
                        <ul>
                            <li>标题：档案的名称，必填</li>
                            <li>描述：关于档案的详细描述，可选</li>
                            <li>入库日期：档案入库的日期，默认为今天</li>
                            <li>份数：此档案的份数，默认为1</li>
                            <li>状态：勾选表示档案在库，取消勾选表示档案已借出</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle text-info me-1"></i> 批量添加提示：</h6>
                        <ul>
                            <li>您最多可以一次添加20个档案</li>
                            <li>只有填写了标题的行才会被保存</li>
                            <li>空行将被自动忽略</li>
                            <li>所有档案将被添加到您选择的档案盒中</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 设置所有份数默认为1
        const countInputs = document.querySelectorAll('input[type="number"]');
        countInputs.forEach(input => {
            if (!input.value) {
                input.value = 1;
            }
        });
        
        // 表单验证
        const form = document.getElementById('add-archives-form');
        form.addEventListener('submit', function(event) {
            const boxSelect = document.getElementById('archive_box');
            
            if (!boxSelect.value) {
                alert('请选择档案盒');
                event.preventDefault();
                return;
            }
            
            // 检查是否至少有一行填写了标题
            const titleInputs = document.querySelectorAll('input[name$="-title"]');
            let hasTitle = false;
            
            titleInputs.forEach(input => {
                if (input.value.trim()) {
                    hasTitle = true;
                }
            });
            
            if (!hasTitle) {
                alert('请至少填写一个档案的标题');
                event.preventDefault();
                return;
            }
        });
    });
</script>
{% endblock %}